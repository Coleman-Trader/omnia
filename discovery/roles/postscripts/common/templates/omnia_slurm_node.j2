#!/bin/bash
#####################################################################################################
#  Omnia Slurm Node:
#      Install required Slurm packages for Compute Nodes
#
#####################################################################################################

LOGFILE="/var/log/xcat/xcat.log"

echo "--------------------------" >> "$LOGFILE"
echo "Starting Slurm Compute Node package installation" | tee -a "$LOGFILE"

# Collect all packages into a single list
ALL_PACKAGES=(
    {% for pkg in common_packages %} "{{ pkg.package }}" {% endfor %}
    {% for pkg in role_specific_packages %} "{{ pkg.package }}" {% endfor %}
)

echo "DEBUG: Installing packages - ${ALL_PACKAGES[*]}" | tee -a "$LOGFILE"

# Install all packages in one command
if ! dnf install -y "${ALL_PACKAGES[@]}" >> "$LOGFILE" 2>&1; then
    echo "WARNING: Some packages failed to install. Check $LOGFILE for details." | tee -a "$LOGFILE"
else
    echo "SUCCESS: All packages installed successfully!" | tee -a "$LOGFILE"
fi

echo "--------------------------" >> "$LOGFILE"
echo "Slurm Compute Node setup complete." | tee -a "$LOGFILE"
