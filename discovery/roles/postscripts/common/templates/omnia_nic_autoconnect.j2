#!/bin/bash
################################################################################################################
#  omnia_nic_autoconnect:
#      Configure autoconnect to all active nic in all the cluster nodes
#      The nic name might change between the installation and 1st boot
#      Active all the nics with network link during system boot
#
#################################################################################################################

[ "$XCATDEBUGMODE" ] || export XCATDEBUGMODE="#TABLEBLANKOKAY:site:key=xcatdebugmode:value#"
[ "$MASTER_IP" ] || export MASTER_IP="#ENV:MASTER_IP#"
#INCLUDE:#ENV:XCATROOT#/share/xcat/install/scripts/scriptlib#

# Set ONBOOT=yes using ifcfg-* files if they exist and are usable
ifcfg_files=($(ls /etc/sysconfig/network-scripts/ifcfg-* | grep -v 'ifcfg-lo'))
# Fallback: check if nmcli is available and working
mncli_available=false
if command -v nmcli >/dev/null 2>&1; then
    # Check if we can list connections
    if nmcli -t -f UUID connection show >/dev/null 2>&1; then
        mncli_available=true
    fi
fi

if [ ${#ifcfg_files[@]} -gt 0 ]; then
  echo "-- Using ifcfg method (preferred) --"
  for i in "${ifcfg_files[@]}";
  do
    nicname="${i##*-}"
    if ethtool $nicname | grep -E -i -q "Link detected.*yes" >/dev/null 2>&1
    then
      case "$XCATDEBUGMODE" in
      "1"|"2")
          msgutil_r "$MASTER_IP" "info" "set NIC $nicname to be activated on system boot" "/var/log/xcat/xcat.log"
          ;;
      esac
      sed -i 's/ONBOOT=no/ONBOOT=yes/' "$i"
    fi
  done
elif [ "$mncli_available" = true ]; then
  echo "-- No ifcfg-* files found, falling back to nmcli --"
  for iface in $(ip -o link show | awk -F': ' '{print $2}');
  do
    state=$(cat /sys/class/net/$iface/operstate)
    if [ "$state" = "up" ]; then
        uuid=$(nmcli -g UUID,DEVICE,NAME connection show | grep ":$iface$" | cut -d: -f1)
        if [ -n "$uuid" ]; then
            echo "Enabling autoconnect for $iface (UUID=$uuid)"
            nmcli connection modify "$uuid" connection.autoconnect yes
        else
            echo "No UUID found for $iface"
        fi
    fi
  done
fi