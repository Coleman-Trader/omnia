# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: Run pulp status command on omnia_core container
  ansible.builtin.command: pulp status
  delegate_to: localhost
  register: pulp_status_output

- name: Set pulp content origin value
  ansible.builtin.set_fact:
    pulp_content_origin: "{{ (pulp_status_output.stdout | from_json).content_settings.content_origin }}"

- name: Set fact for pulp protocol
  ansible.builtin.set_fact:
    pulp_protocol: "{{ pulp_content_origin | urlsplit('scheme') }}"

- name: Set fact for pulp server IP or hostname
  ansible.builtin.set_fact:
    pulp_server_ip: "{{ pulp_content_origin | urlsplit('hostname') }}"

- name: Set fact for pulp_protocol_https
  ansible.builtin.set_fact:
    pulp_protocol_https: "{{ pulp_protocol != 'http' }}"

- name: Get dependencies from local repo
  block:
    - name: Gather facts on Pulp container
      containers.podman.podman_container_info:
        name: "{{ pulp_container_name }}"
      register: container_info

    - name: Success if pulp container is running
      ansible.builtin.debug:
        msg: "{{ pulp_container_success_msg }}"
      when:
        - container_info.containers | length > 0
        - container_info.containers[0].State.Status == 'running'

    - name: Fail if pulp container is not running
      ansible.builtin.fail:
        msg: "{{ pulp_container_fail_msg }}"
      when:
        - container_info.containers | length == 0 or container_info.containers[0].State.Status != 'running'

- name: Check if Pulp endpoint is up
  block:
    - name: Set Pulp status URL based on protocol
      ansible.builtin.set_fact:
        pulp_status_url: "{{ pulp_status_url_https if pulp_protocol_https else pulp_status_url_http }}"

    - name: Check if Pulp endpoint is up
      ansible.builtin.uri:
        url: "{{ pulp_status_url }}"
        method: GET
        validate_certs: false
        return_content: true
      register: result
      retries: "{{ endpoint_retries }}"
      delay: "{{ endpoint_delay }}"
      timeout: "{{ endpoint_timeout }}"
      until: result.status == 200

    - name: Fail when Pulp endpoint is not up
      ansible.builtin.debug:
        msg: "{{ pulp_status_fail_msg }}"
      when: result.status != 200
